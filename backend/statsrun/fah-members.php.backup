#!/usr/bin/php
<?php

include (dirname(realpath($argv[0])) . '/../include.php');

function getSubteam($name)
{
	$team = '';
	
	$name = str_replace('\'', '\\\'', $name);
	
	$query = 'SELECT
			name
		FROM
			fah_subteam
		WHERE
			member = \'' . $name . '\'';

	$result = mysql_query($query) or die('');

	if ( $line = mysql_fetch_array($result) )
	{
		$team = $line['name'];
	}
	
	return $team;
}

$datum = getCurrentDate('tsc');

$html = file('http://vspx27.stanford.edu/teamstats/team92.txt') or die("Error retrieving information");

$members = array();
$subteams = array();
$subteamMembers = array();

for($line=10;$line<count($html);$line++)
{
	$data = preg_replace('/\s\s+/', ' ', $html[$line]);
	$data = str_replace("\t", ' ', $data);

	$info = explode(' ', $data);
	$user = $info[2];
	#$user = str_replace('[DPC]_Team_Coldfusion0', '[DPC]_Team_ColdFusion0', $user);
	#$user = str_replace('Sandstar', 'SandStar', $user);
	$score = $info[3];

	if ( $score == 0 ) break;
	
	#echo $info[2] . ' ' . $info[3] . "\n";
	
	$team = getSubteam($user);
	if ( $team != '' )
	{
		$subteams[$team] += $score;
		$subteamMembers[$team][$user] = $score;
	}
	elseif ( is_numeric(strpos($user, '0')) )
	{
		$pos = strpos($user, '0');
		$team = substr($user, 0, $pos);
		$user = substr($user, ( $pos + 1 ) );
	#	echo $user . ' - ' . $team . "\n";
		
		$set = 0;
		foreach($subteams as $stName => $stScore)
		{
			if ( strtoupper($stName) == strtoupper($team) )
			{
				$set = 1;
				$subteams[$stName] += $score;
				
				#if ( ! isset($subteamMembers[$stName]) ) $subteamMembers[$stName] = array();

				$subteamMembers[$stName][$user] = $score;

			}
		}

		if ( $set == 0 )
		{
			$subteams[$team] = $score;
				
			$subteamMembers[$team] = array();

			$subteamMembers[$team][$user] = $score;
		}
	}
	else
	{
		/*
		$set = 0;
		foreach($subteams as $stName => $stScore)
		{
			if ( strtoupper($stName) == strtoupper($user) )
			{
				if ( isset($subteams[$stName]) )
					$subteams[$stName] += $score;
				else
					$subteams[$stName] = $score;

				$set++;
			}
		}

		$set2 = 1;
		if ( $set != 0 )
		{/*/
			$set = 0;
			foreach($members as $mName => $mScore)
			{
				if ( strtoupper($mName) == strtoupper($user) )
				{
					$members[$mName] += $score;
					$set++;
				}
			}
	#	}
		
		if ( $set == 0 )
			$members[$user] = $score;
	}
}

foreach($members as $mName => $mScore)
{
	foreach($subteams as $stName => $stScore)
	{
		if ( strtoupper($mName) == strtoupper($stName) )
		{
			#$stScore += $mScore;
			$subteams[$stName] += $mScore;
			$subteamMembers[$stName][$mName] = $mScore;
			#echo $mName . "\n";
		}
	}
}

foreach ( $subteams as $name => $score )
{
	if ( count($subteamMembers[$name] ) > 1 )
	{
		#$members[$name] = $score;
		#echo $name . ' ' . $score . "\n";
		if ( $name != '' )
			$members[$name] = $score;
	}
	else
	{
		foreach($subteamMembers[$name] as $temp =>  $tmpname)
			$members[$name . '0' . $temp] = $score;
	}
}

arsort($members, SORT_NUMERIC);
foreach($members as $name => $score)
	$fahmembers[] = new Member($name, $score);

addStatsrun($fahmembers, 'fah_memberoffset');

$fahsubteammembers = array();
foreach ( $subteamMembers as $subTeamName => $member )
	foreach ( $member as $memberName => $memberScore )
	{
		if ( ( ! $subTeamName == '0' ) && (  count($subteamMembers[$subTeamName]) > 1 ) )
			$fahsubteammembers[] = new TeamMember($memberName, $memberScore, $subTeamName);
	}

addSubTeamStatsRun($fahsubteammembers, 'fah_subteamoffset');
?>
